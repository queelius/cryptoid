{{/*
  Cryptoid Encrypted Content Shortcode (v2 multi-user)

  Usage:
    {{< cryptoid-encrypted mode="user" hint="Password hint" remember="ask" hash="..." >}}
    <base64-encoded-ciphertext>
    {{< /cryptoid-encrypted >}}

  Parameters:
    - mode: "user" for username+password (v2 multi-user)
    - hint: Optional password hint to display
    - remember: Password storage mode ("none", "session", "local", "ask")
    - hash: Content hash for integrity verification (truncated SHA-256)
*/}}

{{ $mode := .Get "mode" | default "user" }}
{{ $hint := .Get "hint" | default "" }}
{{ $remember := .Get "remember" | default "ask" }}
{{ $hash := .Get "hash" | default "" }}
{{ $ciphertext := .Inner | strings.TrimSpace }}
{{ $id := printf "cryptoid-%s" (md5 $ciphertext | truncate 8 "") }}

<div class="cryptoid-container" id="{{ $id }}" data-mode="{{ $mode }}" data-remember="{{ $remember }}"{{ if $hash }} data-content-hash="{{ $hash }}"{{ end }}>
  <noscript>
    <div class="cryptoid-noscript">
      This content is encrypted and requires JavaScript to view.
    </div>
  </noscript>

  <form class="cryptoid-form" onsubmit="return cryptoidDecrypt('{{ $id }}', event)">
    <div class="cryptoid-lock-icon">ðŸ”’</div>
    <p class="cryptoid-message">This content is password protected.</p>
    {{ if $hint }}
    <p class="cryptoid-hint">Hint: {{ $hint }}</p>
    {{ end }}

    {{ if eq $mode "user" }}
    <div class="cryptoid-input-group">
      <input
        type="text"
        class="cryptoid-username"
        placeholder="Enter username"
        autocomplete="username"
        required
      />
    </div>
    {{ end }}

    <div class="cryptoid-input-group">
      <input
        type="password"
        class="cryptoid-password"
        placeholder="Enter password"
        autocomplete="current-password"
        required
      />
      <button type="submit" class="cryptoid-submit">Unlock</button>
    </div>

    {{ if eq $remember "ask" }}
    <label class="cryptoid-remember-label">
      <input type="checkbox" class="cryptoid-remember-checkbox" />
      Remember credentials
    </label>
    {{ end }}

    <div class="cryptoid-error" style="display: none;"></div>
  </form>

  <div class="cryptoid-content" style="display: none;"></div>

  <template class="cryptoid-ciphertext">{{ $ciphertext }}</template>
</div>

{{/* Include CSS and JS only once per page */}}
{{ if not (.Page.Scratch.Get "cryptoidIncluded") }}
  {{ .Page.Scratch.Set "cryptoidIncluded" true }}
  <style>
    .cryptoid-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 2rem;
      margin: 1rem 0;
      background: #f9f9f9;
    }
    .cryptoid-form {
      text-align: center;
    }
    .cryptoid-lock-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .cryptoid-message {
      color: #666;
      margin-bottom: 0.5rem;
    }
    .cryptoid-hint {
      color: #888;
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 1rem;
    }
    .cryptoid-input-group {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .cryptoid-username,
    .cryptoid-password {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      width: 200px;
    }
    .cryptoid-submit {
      padding: 0.5rem 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .cryptoid-submit:hover {
      background: #0056b3;
    }
    .cryptoid-remember-label {
      display: block;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .cryptoid-error {
      color: #dc3545;
      margin-top: 1rem;
    }
    .cryptoid-content {
      line-height: 1.6;
    }
    .cryptoid-noscript {
      color: #856404;
      background: #fff3cd;
      padding: 1rem;
      border-radius: 4px;
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      .cryptoid-container {
        background: #1a1a1a;
        border-color: #333;
      }
      .cryptoid-message {
        color: #aaa;
      }
      .cryptoid-hint {
        color: #888;
      }
      .cryptoid-username,
      .cryptoid-password {
        background: #2a2a2a;
        border-color: #444;
        color: #eee;
      }
      .cryptoid-remember-label {
        color: #aaa;
      }
    }
  </style>
  <script src="{{ "js/cryptoid.js" | relURL }}"></script>
{{ end }}
