{{/*
  Cryptoid Encrypted Content Shortcode (v2 multi-user)

  Usage:
    {{< cryptoid-encrypted mode="user" hint="Password hint" remember="ask" hash="..." >}}
    <base64-encoded-ciphertext>
    {{< /cryptoid-encrypted >}}

  Parameters:
    - mode: "user" for username+password (v2 multi-user)
    - hint: Optional password hint to display
    - remember: Password storage mode ("none", "session", "local", "ask")
    - hash: Content hash for integrity verification (truncated SHA-256)
*/}}

{{ $mode := .Get "mode" | default "user" }}
{{ $hint := .Get "hint" | default "" }}
{{ $remember := .Get "remember" | default "ask" }}
{{ $hash := .Get "hash" | default "" }}
{{ $ciphertext := .Inner | strings.TrimSpace }}
{{ $id := printf "cryptoid-%s" (md5 $ciphertext | truncate 8 "") }}

<div class="cryptoid-container" id="{{ $id }}" data-mode="{{ $mode }}" data-remember="{{ $remember }}"{{ if $hash }} data-content-hash="{{ $hash }}"{{ end }}>
  <noscript>
    <div class="cryptoid-noscript">
      This content is encrypted and requires JavaScript to view.
    </div>
  </noscript>

  <form class="cryptoid-form" onsubmit="return cryptoidDecrypt('{{ $id }}', event)">
    <div class="cryptoid-lock-icon">ðŸ”’</div>
    <p class="cryptoid-message">This content is password protected.</p>
    {{ if $hint }}
    <p class="cryptoid-hint">Hint: {{ $hint }}</p>
    {{ end }}

    {{ if eq $mode "user" }}
    <div class="cryptoid-input-group">
      <input
        type="text"
        class="cryptoid-username"
        placeholder="Enter username"
        autocomplete="username"
        required
      />
    </div>
    {{ end }}

    <div class="cryptoid-input-group">
      <input
        type="password"
        class="cryptoid-password"
        placeholder="Enter password"
        autocomplete="current-password"
        required
      />
      <button type="submit" class="cryptoid-submit">Unlock</button>
    </div>

    {{ if eq $remember "ask" }}
    <label class="cryptoid-remember-label">
      <input type="checkbox" class="cryptoid-remember-checkbox" />
      Remember credentials
    </label>
    {{ end }}

    <div class="cryptoid-error" style="display: none;"></div>
  </form>

  <div class="cryptoid-content" style="display: none;"></div>

  <template class="cryptoid-ciphertext">{{ $ciphertext }}</template>
</div>

{{/* Include CSS and JS only once per page */}}
{{ if not (.Page.Scratch.Get "cryptoidIncluded") }}
  {{ .Page.Scratch.Set "cryptoidIncluded" true }}
  <style>
    .cryptoid-container {
      border: 1px solid rgba(128, 128, 128, 0.3);
      border-radius: 8px;
      padding: 2rem;
      margin: 1rem 0;
      background: rgba(128, 128, 128, 0.06);
    }
    /* After unlock, strip container chrome so content looks native */
    .cryptoid-container.cryptoid-unlocked {
      border: none;
      border-radius: 0;
      padding: 0;
      margin: 0;
      background: none;
    }
    .cryptoid-form {
      text-align: center;
    }
    .cryptoid-lock-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }
    .cryptoid-message {
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }
    .cryptoid-hint {
      opacity: 0.5;
      font-size: 0.9rem;
      font-style: italic;
      margin-bottom: 1rem;
    }
    .cryptoid-input-group {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .cryptoid-username,
    .cryptoid-password {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(128, 128, 128, 0.4);
      border-radius: 4px;
      font-size: 1rem;
      width: 200px;
      background: rgba(128, 128, 128, 0.1);
      color: inherit;
    }
    .cryptoid-submit {
      padding: 0.5rem 1rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .cryptoid-submit:hover {
      background: #0056b3;
    }
    .cryptoid-remember-label {
      display: block;
      opacity: 0.6;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .cryptoid-error {
      color: #dc3545;
      margin-top: 1rem;
    }
    .cryptoid-lock-btn {
      display: inline-block;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      background: rgba(128, 128, 128, 0.15);
      color: inherit;
      border: 1px solid rgba(128, 128, 128, 0.3);
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 1rem;
      opacity: 0.7;
    }
    .cryptoid-lock-btn:hover {
      opacity: 1;
      background: rgba(128, 128, 128, 0.25);
    }
    .cryptoid-content {
      line-height: 1.6;
    }
    .cryptoid-content h1,
    .cryptoid-content h2,
    .cryptoid-content h3 {
      margin-top: 1.5em;
      margin-bottom: 0.5em;
    }
    .cryptoid-content p {
      margin-bottom: 1em;
    }
    .cryptoid-content ul,
    .cryptoid-content ol {
      margin-bottom: 1em;
      padding-left: 1.5em;
    }
    .cryptoid-content li {
      margin-bottom: 0.25em;
    }
    .cryptoid-content pre {
      background: rgba(128, 128, 128, 0.1);
      border-radius: 4px;
      padding: 1em;
      overflow-x: auto;
      margin-bottom: 1em;
    }
    .cryptoid-content code {
      font-size: 0.9em;
    }
    .cryptoid-content a {
      color: #007bff;
      text-decoration: underline;
    }
    .cryptoid-noscript {
      color: #856404;
      background: #fff3cd;
      padding: 1rem;
      border-radius: 4px;
    }
  </style>
  <script src="{{ "js/marked.min.js" | relURL }}"></script>
  <script src="{{ "js/cryptoid.js" | relURL }}"></script>
{{ end }}
